import PDFDocument from 'pdfkit'
import { downloadAsBase64, uploadImage, getPublicUrl } from '../_lib/storage.js'
import { supabase } from '../_lib/supabase.js'

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).json({ error: 'Method not allowed' })

  try {
    const { projectId, logoId, brandKit } = req.body

    const { data: project } = await supabase
      .from('projects')
      .select('*')
      .eq('id', projectId)
      .single()

    // Download logo
    const { data: logo } = await supabase
      .from('logos')
      .select('storage_path')
      .eq('id', logoId)
      .single()

    const url = new URL(logo.storage_path)
    const pathMatch = url.pathname.match(/\/logos\/(.+)/)
    const logoBase64 = pathMatch ? await downloadAsBase64('logos', pathMatch[1]) : null

    // Generate PDF
    const doc = new PDFDocument({ size: 'A4', margin: 50 })
    const chunks = []

    doc.on('data', (chunk) => chunks.push(chunk))

    await new Promise((resolve) => {
      doc.on('end', resolve)

      const brief = project?.company_brief || {}

      // Title
      doc.fontSize(28).font('Helvetica-Bold').text(brief.company_name || 'Brand Guide', { align: 'center' })
      doc.moveDown(0.5)
      doc.fontSize(12).font('Helvetica').fillColor('#666666').text('Brand Identity Summary', { align: 'center' })
      doc.moveDown(2)

      // Logo
      if (logoBase64) {
        const logoBuffer = Buffer.from(logoBase64, 'base64')
        doc.image(logoBuffer, { fit: [200, 200], align: 'center' })
        doc.moveDown(2)
      }

      // Color Palette
      if (brandKit?.colorPalette) {
        doc.fontSize(16).font('Helvetica-Bold').fillColor('#000000').text('Color Palette')
        doc.moveDown(0.5)

        brandKit.colorPalette.forEach((color) => {
          doc.fontSize(11).font('Helvetica')
            .fillColor('#333333')
            .text(`${color.name}: ${color.hex}`)
        })
        doc.moveDown(1)
      }

      // Typography
      if (brandKit?.fontIdentification) {
        doc.fontSize(16).font('Helvetica-Bold').fillColor('#000000').text('Typography')
        doc.moveDown(0.5)
        doc.fontSize(11).font('Helvetica').fillColor('#333333')
        if (brandKit.fontIdentification.primary) {
          doc.text(`Primary: ${brandKit.fontIdentification.primary}`)
        }
        if (brandKit.fontIdentification.secondary) {
          doc.text(`Secondary: ${brandKit.fontIdentification.secondary}`)
        }
        doc.moveDown(1)
      }

      // Usage Guidelines
      if (brandKit?.usageGuidelines) {
        doc.fontSize(16).font('Helvetica-Bold').fillColor('#000000').text('Usage Guidelines')
        doc.moveDown(0.5)
        doc.fontSize(11).font('Helvetica').fillColor('#333333').text(brandKit.usageGuidelines)
        doc.moveDown(1)
      }

      // Brand Brief
      doc.fontSize(16).font('Helvetica-Bold').fillColor('#000000').text('Brand Brief')
      doc.moveDown(0.5)
      doc.fontSize(11).font('Helvetica').fillColor('#333333')

      if (brief.industry) doc.text(`Industry: ${brief.industry}`)
      if (brief.target_audience) doc.text(`Audience: ${brief.target_audience}`)
      if (brief.tone) doc.text(`Tone: ${brief.tone}`)
      if (brief.values) doc.text(`Values: ${brief.values.join(', ')}`)

      doc.moveDown(2)
      doc.fontSize(8).fillColor('#999999').text('Generated by Logo Explorer', { align: 'center' })

      doc.end()
    })

    const pdfBuffer = Buffer.concat(chunks)
    const pdfPath = `${projectId}/${logoId}/brand-summary.pdf`
    await uploadImage('exports', pdfPath, pdfBuffer.toString('base64'), 'application/pdf')

    res.status(200).json({
      path: getPublicUrl('exports', pdfPath),
    })
  } catch (err) {
    res.status(500).json({ error: err.message })
  }
}
